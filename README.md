# Discord Bot Example for Discord.py
discord.pyを使用してPythonでDiscordのBotアプリケーションを作成してみたい方向けのリポジトリになります。
以下のような方に有用なサンプルになるかと思います。
- とりあえず何か作ってみたいけど何から手を付ければ良いかわからない
- 雛形的なものが欲しい
- DiscordのBotがどういう仕組なのか知りたい

Discord Developer Portal上で必要な手順やその他詳細な解説については今後ブログ等で別途解説記事を掲載予定。

> [!NOTE]
> あくまでExample(使用例)ですのでdiscord.py全ての機能を網羅しているわけではありません。
> 本格的な実装や運用には処理の最適化や複数サーバー上での動作を考慮した設計など他にも必要なモノが多くあります。
> それらの前段階としてdiscord.pyを知る手段の1つとして参考にしていただければと思います。


## discord.pyについて
PythonでDiscordのBotアプリケーションなどを開発することが出来るライブラリです。
情報が多く、公式ドキュメントも大部分が日本語化されている為導入しやすい点が魅力です。
同様のライブラリに[Pycord (Python)](https://pycord.dev/)や[discord.js (JS/TS)](https://discord.js.org/)などがあります。気になる方はこれらもチェックしてみてください。

このリポジトリではdiscord.py v2.x系の利用を前提とした内容となります。
- [discord.py - GitHub](https://github.com/Rapptz/discord.py)
- [公式ドキュメント](https://discordpy.readthedocs.io/ja/latest/index.html)

## 使用されている機能
このリポジトリではdiscord.pyの使用例として以下の機能を使用して作成されています。
| 機能 | 使用目的 |
| :---: | :---: |
| スラッシュコマンド | アプリケーションコマンドの実装 |
| Cog/Extension | コードの分割、可読性・メンテナンス性の向上 |
| Bot UIキット | ボタンやモーダルウィンドウなどのUI表示機能の実装 |

### 【スラッシュコマンド】
スラッシュコマンドとはBotの機能を使用する際に`/command`のような形で呼び出すコマンド機能のことです。
何かしらのDiscordのBotアプリケーションを使用したことのある方なら見たことがあるかと思います。

DiscordのBotアプリケーションにはこちらとは別で`プレフィックス`を利用したコマンド呼び出し方法があり、呼び出す際は例えば`!command`であったり`m!play`であったりと、アプリケーションごとに独自で頭文字部分の設定が可能です。
ただし、こちらのプレフィックスを使用したメッセージベースのコマンド呼び出し方法ではアプリケーションによってはこのプレフィックス(頭文字の`!`や`m!`部分)が重複してしまった場合などに思わぬ挙動を起こしてしまう可能性などがあります。

その他プレフィックスを利用したコマンド機能に対してスラッシュコマンドは以下のような優位性を持ちます。
- コマンド一覧をDiscord上で確認できる
- コマンド一覧上に機能説明を表記することもできる
- 別のBotと同名のコマンドになっていても区別される
- 引数等のパラメーター受取も容易

これらの理由からこのリポジトリでもスラッシュコマンドでのコマンド機能実装となっています。

### 【Cog/Extension】
Cog及びExtensionはdiscord.pyでBot開発を行う場合に、機能ごとにコードを分割して管理することが出来る機能です。

よく目にするdiscord.pyのチュートリアルなどでは1つのスクリプトファイルに全ての機能を記述する例が多いですが、開発を進めていき機能が充実してくるとコードのボリュームも必然的に増え、可読性やメンテナンス性が低下してくる恐れがあります。
そこでCogという機能でBotの各機能をクラス単位で分割し、それぞれをExtension(拡張機能)として管理することでコードの整理やメンテナンスをしやすくすることが可能になります。(モジュールやパッケージに近いです)

例えば1つのファイル`bot.py`に
- チャット読み上げ機能
- 自動ロール付与機能
- ウェルカムメッセージ機能
- ユーザーアクティビティ記録機能
- グループ分け機能

のような実装内容が記述されている場合は以下のように分けることでコードの内容とファイルを分割することができます。
| ファイル名 | Cog | 内容 |
| :---: | :---: | :---: |
| `tts.py` | TextToSpeechCog | チャット読み上げ機能関連 |
| `auto_role.py` | AutoRoleCog | 自動ロール付与機能関連 |
| `welcome.py` | WelcomeCog | ウェルカムメッセージ機能関連 |
| `user_activity.py` | UserActivityCog | ユーザーアクティビティ記録機能関連 |
| `team_div.py` | TeamDivCog | グループ分け機能関連 |

また、Extensionとして個別にした機能は`bot.py`から各機能を呼び出すような形になるため、
例えば一時的に無効にしたい機能は読み込むExtensionのリストから除外するだけで簡単に機能制限などを行うことも出来ます。
```python
# 読み上げ機能だけ一時的に無効にしたい場合
self.initial_extensions = [
    # 'cogs.tts',
    'cogs.auto_role',
    'cogs.welcome',
    'cogs.user_activity',
    'team_div',
    ]
```

その他、今回のリポジトリには含めておりませんが、Extensionにはホットリロード機能もあり、部分的な機能の変更があった際に『アプリケーション全体を再起動せず、Extensionを再読み込みするだけで機能の更新を行う』といったようなことも可能です。

### 【Bot UIキット】
DiscordのBotで機能開発を行っていくと欠かせないのがDiscordのUI表示機能です。
discord.pyでは主に以下のUIアイテムを任意で設置することができます。
- ボタン
- ドロップダウンメニュー
- モーダルウィンドウ (テキスト入力エリア)

これらのアイテムを使用することで『ボタンを押したら指定されたロールが付与される機能』や『入力された参加者をグループ分けして表示する機能』などスラッシュコマンドだけでは再現が難しい機能などを容易に実装することが可能になります。

## 動作に必要な準備
### Dockerコンテナを利用する場合(推奨)
コンピューター上にDockerがインストールされていれば、このリポジトリを`git clone`後に以下手順の5~8を行い`docker compose up`するだけでBotを立ち上げることが可能です。

### コンピューター上で直接アプリケーションを立ち上げる場合
動作させたいコンピューター上に以下を導入した上で進めてください。
- Git
- Python (3.10.9~3.12.8まで動作確認済み)
- ffmpeg (パスを通してください)

今回はWindowsのコマンドプロンプトでの操作を例として説明します。
Discord Developer Portalでの操作やサーバーIDの取得方法などは省略します。
1. このリポジトリを`git clone`する
2. コマンドプロンプトでクローンしたリポジトリのディレクトリを開き、以下のコマンドでPythonの仮想環境を作成
```
python -m venv venv
```
3. 仮想環境の立ち上げ
```
venv\Scripts\activate
```
4. 必要パッケージのインストール
```
pip install -r requirements.txt
```
5. [Discord Developer Portal](https://discord.com/developers/docs/intro)でアプリケーションを作成し、トークンとBot招待用のURLを取得
6. `.env-example`を`.env`にリネームし、`YourDiscordTokenHere`の部分を取得したトークンに書き換える
7. 取得した招待用URLから任意のサーバーにBotを招待する
8. 招待したサーバーのサーバーIDを取得し、`.env`の`YourDiscordServerIdHere`の部分をサーバーIDに書き換える
9. 仮想環境を立ち上げた状態のコマンドプロンプトから以下のコマンドでBotを起動
```
python bot.py
```
10. Discord上でBotを使用して動作を確認する

## 参考
- [Discord.py公式ドキュメント](https://discordpy.readthedocs.io/ja/stable/)